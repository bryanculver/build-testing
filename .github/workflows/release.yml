---
name: "Release"

on:
  release:
    types:
      - "published"
  push:
    branches:
      - "main"

jobs:
  push:
    if: "!github.event.release.draft"
    runs-on: "ubuntu-24.04"
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.10", "3.11", "3.12", "3.13" ]
    permissions:
      contents: "read"
      packages: "write"
    env:
      BUILD_PUSH_CONTAINER_ACTION_DEFAULT_PYTHON_VERSION: "3.13"
      BUILD_PUSH_CONTAINER_ACTION_SET_LATEST: "true" # this will be ignored for pre-releases
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"
      - run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
        id: "gitbranch"
      - name: "Set up QEMU"
        uses: "docker/setup-qemu-action@2b82ce82d56a2a04d2637cd93a637ae1b359c0a7" # v2
      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@885d1462b80bc1c1c7f0b00334ad271f09369c55" # v2
      - name: "Login to GitHub Container Registry"
        uses: "docker/login-action@465a07811f14bebb1938fbed4728c6a1ff8901fc" # v2
        with:
          registry: "ghcr.io"
          username: "${{ github.actor }}"
          password: "${{ secrets.GITHUB_TOKEN }}"

      - name: "Determine if nautobot-version is branch name or from tag name"
        id: "versionname"
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "nautobot-version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "nautobot-version=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi

      - name: "Build and Push (prod)"
        uses: "./.github/actions/build-push-container"
        with:
          images: "ghcr.io/${{ github.repository }}"
          python-version: "${{ matrix.python-version }}"
          nautobot-version: "${{ steps.versionname.outputs.nautobot-version }}"
          push: true
          target: "final"
          default-python-version: "{{ env.BUILD_PUSH_CONTAINER_ACTION_DEFAULT_PYTHON_VERSION }}"
          set-latest: "{{ env.BUILD_PUSH_CONTAINER_ACTION_SET_LATEST }}"
          cache-scope: "nautobot-${{ steps.gitbranch.outputs.branch }}-${{ matrix.python-version }}"

      - name: "Build and Push (dev)"
        uses: "./.github/actions/build-push-container"
        with:
          images: "ghcr.io/${{ github.repository }}"
          python-version: "${{ matrix.python-version }}"
          nautobot-version: "${{ steps.versionname.outputs.nautobot-version }}"
          push: true
          target: "final-dev"
          default-python-version: "${{ env.BUILD_PUSH_CONTAINER_ACTION_DEFAULT_PYTHON_VERSION }}"
          set-latest: "${{ env.BUILD_PUSH_CONTAINER_ACTION_SET_LATEST }}"
          cache-scope: "nautobot-dev-${{ steps.gitbranch.outputs.branch }}-${{ matrix.python-version }}"
